{% extends "sensors/base.html" %}

{% block title %}Sensors recent history{% endblock %}
{% block content %}
    <style>
        #temperature_chart_container, #humidity_chart_container {
            position: relative;
            font-family: Arial, Helvetica, sans-serif;
        }
        #temperature_chart, #humidity_chart {
            position: relative;
            left: 40px;
        }
        #temperature_y_axis, #humidity_y_axis {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 40px;
        }
    </style>

    <table border="1">
        <tr><th>Temperature</th><th>Humidity</th></tr>

{% if one_reading %}
    {# TODO show trending data e.g. up 3% in the last 5 minutes #}
    {%  if one_reading.is_current %}
        <tr>
            <td>Currently: {{ one_reading.temperature_celsius }}&deg;C [insert trend data]</td>
            <td>Currently: {{ one_reading.humidity_percent }}% [insert trend data]</td>
        </tr>
    {% else %}
        <tr>
            <td>{{ one_reading.temperature_celsius }}&deg;C at {{ one_reading.compact_date }} [insert trend data]</td>
            <td>{{ one_reading.humidity_percent }}% at {{ one_reading.compact_date }} [insert trend data]</td>
        </tr>
    {% endif %}
{% else %}
    No reading available.<br>
{% endif %}

        {# TODO: Fix this mess. Use divs not tables, or make sure the insertion of the axis div doesn't cause overflow into the next cell #}
        <tr><td>
            <div id="temperature_chart_container">
                <div id="temperature_y_axis"></div>
                <div id="temperature_chart"></div>
            </div>
            </td>
            <td>
            <div id="humidity_chart_container">
                <div id="humidity_y_axis"></div>
                <div id="humidity_chart"></div>
            </div>
            </td>
        </tr>
    </table>

{% if reading_context %}

<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}rickshaw.min.css">
<script src="{{ STATIC_URL }}vendor/d3.min.js"></script>
<script src="{{ STATIC_URL }}vendor/d3.layout.min.js"></script>
<script src="{{ STATIC_URL }}rickshaw.min.js"></script>

<script type="text/javascript">

var temperature_data = [
    {% for reading in reading_context %}{ x: {{ reading.datetime_read_as_seconds_since_epoch_local_tz }}, y: {{ reading.temperature_celsius }} },
    {% endfor %}];
var humidity_data = [
    {% for reading in reading_context %}{ x: {{ reading.datetime_read_as_seconds_since_epoch_local_tz }}, y: {{ reading.humidity_percent }} },
    {% endfor %}];

var palette = new Rickshaw.Color.Palette();

var temperature_graph = new Rickshaw.Graph( {
    element: document.querySelector("#temperature_chart"),
    width: 400,
    height: 200,
    renderer: 'line',
    series: [{
        name: "Temperature",
        data: temperature_data,
        color: palette.color()
    }]
});

var temperature_x_axis = new Rickshaw.Graph.Axis.Time( {
    graph: temperature_graph
});

var temperature_y_axis = new Rickshaw.Graph.Axis.Y( {
    graph: temperature_graph,
    orientation: 'left',
    element: document.getElementById('temperature_y_axis')
} );

temperature_graph.render();

var humidity_graph = new Rickshaw.Graph( {
    element: document.querySelector("#humidity_chart"),
    width: 400,
    height: 200,
    renderer: 'line',
    series: [{
        name: "Humidity",
        data: humidity_data,
        color: palette.color()
    }]
});
var humidity_x_axis = new Rickshaw.Graph.Axis.Time( {
    graph: humidity_graph
});

var humidity_y_axis = new Rickshaw.Graph.Axis.Y( {
    graph: humidity_graph,
    orientation: 'left',
    element: document.getElementById('humidity_y_axis')
} );

humidity_graph.render();

</script>

{% else %}
    No context available.<br>
{%  endif %}
{% endblock %}